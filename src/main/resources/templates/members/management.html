<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head> <meta charset="utf-8">
  <title>Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />

  <style>
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .header {
      height: 10vh;
      width: 100%;
      border-bottom: 5px solid #483D8B;
      text-align: center;
      margin-bottom: 30px;
    }
    .menu{
      height: 70vh;
      background-color: azure;
      border-radius: 0 0 50px 50px;
      border: none;
      overflow-y: scroll;
    }
    .menu::-webkit-scrollbar {
      display: none;
    }
    .title{
      height: 10vh;
      display: flex;
      flex-wrap: wrap;
      background-color: #0081CC;
      border-radius: 50px 50px 0px 0px;
      border: none;
    }
    .button {
      background-color: red;
      border: none;
      color: white;
      height: 90%;
      width: 90%;
      text-align: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 10%;
      margin: 4px 4px;
    }
    .tagButton {
      width: 100px;
      height: 50px;

      background-color: #cccccc;
      border: 0;
      border-top-left-radius: 10%;
      border-top-right-radius: 10%;

      margin-right: 1px;
    }
    #menu button {
      width: 100%;
      height: 6vh;
      font-size: 20px;
      border: none;
      border-bottom: 1px solid black;
    }
    #storeItem input{
      border-bottom: 100px;
    }
    .member-detail {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      background-color: white;
      height: 83vh;
    }

    thead th {
      text-align: center;
    }

    .orderList td {
      cursor: pointer;
    }

    .selected {
      background-color: white;
    }

    #orderItemLists {
      display: block;
      height: 100%;
      max-height: 100%;
      overflow: scroll;
      border-bottom: 2px solid dimgray;
    }
    #orderItemLists::-webkit-scrollbar {
      display: none;
    }

    #orderItemLists td {
      text-align: center;
    }
  </style>
  <style>
    .modal{
      position: absolute;
      display: none;

      justify-content: center;
      top: 0;
      left: 0;

      width: 100%;
      height: 100%;

      background-color: rgb(0, 0, 0, 0.4);    /* 0.4는 투명도 설정 */
    }
    .modal-body {
      position: absolute;
      top: 50%;   /* 모달을 화면 가운데 놓기 위해 */

      width: 600px;    /* 모달의 가로 크기 */
      height: 400px;   /* 모달의 세로 크기 */

      padding: 40px;

      text-align: center;

      background-color: white;  /* 모달창 배경색 */
      box-shadow: 2 2px 3px 0 #464646; /* 테두리 그림자 */
      border-radius: 20px;

      transform: translateY(-50%); /* 모듈창 열었을 때 위치 설정 가운데로*/
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body style="background-color:#1E90FF;">
<div style="height: 100vh;">
  <div class="container">
    <div class="header center">
      <div class="col-11" style="padding-left: 10px; font-size: 30px;">
        <button style="position: absolute; left: 0;" onclick="location.href='/'">
          <strong><h1>←</h1></strong>
        </button>
        <h1 style="width: 100%; text-align: center"><strong>사용자 관리</strong></h1>
      </div>
    </div>
    <div class="row">
      <div class="col-12" id="management" style="height: 60vh">
        <div class="col-12" style="height: 7vh; display: flex;">
          <div class="col-6" style="display: flex;">
            <button class="tagButton" id="admin"
                    onclick="location.href='/members/management?memberTag=admin'">관리자<br/>수정</button>
            <button class="tagButton" id="memberSet"
                    onclick="location.href='/members/management?memberTag=memberSet'">회원정보<br/>수정</button>
            <button class="tagButton" id="salary"
                    onclick="location.href='/members/management?memberTag=salary'">월급 관리</button>
          </div>
          <div class="col-6" style="display: flex; justify-content: right;  padding-bottom: 10px;">
            <form class="col-12" action="/members/management" method="get" style="text-align: right">
              <th:block th:if="${memberTag} == 'salary'">
                <input type="month" name="searchDate" class="col-4" th:value="${searchDate}">
              </th:block>
              <input type="text" id="memberName" name="searchName" class="col-4" placeholder="회원 이름">
              <input type="hidden" name="memberTag" th:value="${memberTag}">
              <input type="submit" value="검색" class="col-2" style="margin-left: 5px;" >
            </form>
          </div>
        </div>
        <div class="col-12" id="memberList" style="height: 70vh; background-color: white">
          <!-- admin table -->
          <table class="members" id="members-1" style="width: 100%; height: 100%">
            <thead style="background-color: #cccccc; width: 100%; height: 3.75vh">
            <tr style="display: table; width: 100%;">
              <th style="width: 10%">번호</th>
              <th style="width: 15%">아이디</th>
              <th style="width: 15%">이름</th>
              <th style="width: 20%">생년월일</th>
              <th style="width: 30%">주소</th>
              <th style="width: 10%">관리자<br/>여부</th>
            </tr>
            </thead>
            <tbody id="memberListBody-1" style="display:block; width: 100%; height: 100%; max-height: 70vh;">
            <!-- th:each를 사용하여 사용자의 정보를 표시 -->
            <th:block th:each="member : ${memberDtoList}">
              <tr th:id="${member.id}" style="border-bottom: 1px solid dimgray; display: table; width: 100%;; height: 10%">
                <td th:text="${member.id}" style="width: 10%; text-align: center;"></td>
                <td th:text="${member.stringId}" style="width: 15%; text-align: center;"></td>
                <td th:text="${member.name}" style="width: 15%; text-align: center;"></td>
                <td th:text="${member.birth}" style="width: 20%; text-align: center;"></td>
                <td th:text="${member.stringAds}" style="width: 30%; text-align: center;"></td>
                <td style="width: 10%; text-align: center;">
                  <input type="checkbox" th:checked="${member.admin}">
                </td>
              </tr>
            </th:block>
            </tbody>
          </table>

          <!-- memberSet table -->
          <table class="members" id="members-2" style="width: 100%; height: 100%">
            <thead style="background-color: #cccccc; width: 100%; height: 3.75vh">
            <tr style="display: table; width: 100%; height: 10%">
              <th style="width: 10%">번호</th>
              <th style="width: 15%">아이디</th>
              <th style="width: 15%">이름</th>
              <th style="width: 20%">생년월일</th>
              <th style="width: 30%">주소</th>
              <th style="width: 10%">저장</th>
            </tr>
            </thead>
            <tbody id="memberListBody-2" style="display:block; width: 100%; height: 100%; max-height: 70vh;">
            <!-- th:each를 사용하여 사용자의 정보를 표시 -->
            <th:block th:each="member : ${memberDtoList}">
              <tr th:id="${member.id}" style="border-bottom: 1px solid dimgray; display: table; width: 100%; height: 10%">
                <td th:text="${member.id}" style="width: 10%; text-align: center;"></td>
                <td th:text="${member.stringId}" style="width: 15%; text-align: center;"></td>
                <td style="width: 15%; text-align: center;">
                  <input type="text" th:value="${member.name}" style="width: 100%">
                </td>
                <td style="width: 20%; text-align: center;">
                  <input type="date" th:value="${member.birth}" style="width: 100%">
                </td>
                <td style="width: 30%; position: relative;">
                  <input type="text" th:value="${member.stringAds}" style="width: 100%;">
                  <button style="position: absolute; right: 0;" onclick="location.href='/'">검색</button>
                </td>
                <td style="width: 10%; text-align: center;">
                  <button style="background-color: #1E90FF; border: 0; border-radius: 10%; color: white;" th:onclick="save([[${member.id}]])">저장</button>
                </td>
              </tr>
            </th:block>
            </tbody>
            <tfoot>

            </tfoot>
          </table>

          <table class="members" id="members-3" style="width: 100%; height: 100%">
            <thead style="background-color: #cccccc; width: 100%; height: 3.75vh">
            <tr style="display: table; width: 100%">
              <th style="width: 10%">번호</th>
              <th style="width: 15%">아이디</th>
              <th style="width: 15%">이름</th>
              <th style="width: 20%">총 시간</th>
              <th style="width: 20%">총 일수</th>
              <th style="width: 20%">월급</th>
            </tr>
            </thead>
            <tbody id="memberListBody-3" style="display:block; width: 100%; height: 100%; max-height: 70vh;">
            <!-- th:each를 사용하여 사용자의 정보를 표시 -->
            <th:block th:each="member : ${memberTimesPaging}">
              <tr th:id="${member.memberId}" style="border-bottom: 1px solid dimgray; display: table; width: 100%; height: 10%">
                <td th:text="${member.memberId}" style="width: 10%; text-align: center;"></td>
                <td th:text="${member.memberStringId}" style="width: 15%; text-align: center;"></td>
                <td th:text="${member.memberName}" style="width: 15%; text-align: center;"></td>
                <td th:text="${member.totalTime} + '시간'" style="width: 20%; text-align: center;"></td>
                <td th:text="${member.totalDay} + '일'" style="width: 20%; text-align: center;"></td>
                <td th:text="${#numbers.formatInteger(member.salary, 0, 'COMMA')} + '원'" style="width: 20%; text-align: center;"></td>
              </tr>
            </th:block>
            </tbody>
            <tfoot>

            </tfoot>
          </table>
        </div>
        <!-- 페이징 처리 -->
        <th:block th:if="${memberTag} != 'salary'">
          <div class="col-12 navigator" style="height: 6vh; display: flex; background-color: white;">
            <ul class="col-10 pagination" id="pagination" style="display: flex; height:100%; justify-content: center;">
              <li class="page-item" th:classappend="${!memberDtoList.hasPrevious()} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${memberDtoList.number - 1}&memberTag=${memberTag}|}">
                  <span><</span>
                </a>
              </li>
              <li th:each="page : ${#numbers.sequence(0, memberDtoList.totalPages - 1)}"
                  th:if="${page >= memberDtoList.totalPages - 5 and page <= memberDtoList.number+5}"
                  th:classappend="${page == memberDtoList.number} ? 'active'"
                  class="page-item">
                <a th:text="${page+1}" class="page-link" th:href="@{|?page=${page}&memberTag=${memberTag}|}"></a>
              </li>
              <li class="page-item" th:classappend="${!memberDtoList.hasNext()} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${memberDtoList.number+1}&memberTag=${memberTag}|}">
                  <span>></span>
                </a>
              </li>
            </ul>
            <div class="col-2" id="saveButton" style="height: 100%; text-align: right;">
              <button style="width:100px; height: 100%; font-size: 20px; border: 0px; border-radius: 10%; background-color: #4caf50; color: white">저장</button>
            </div>
          </div>
        </th:block>
        <th:block th:if="${memberTag} == 'salary'">
          <div class="col-12 navigator" style="height: 6vh; display: flex; background-color: white;">
            <ul class="col-12 pagination" style="display: flex; height:100%; justify-content: center;">
              <li class="page-item" th:classappend="${!memberTimesPaging.hasPrevious()} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${memberTimesPaging.number - 1}&memberTag=${memberTag}|}">
                  <span><</span>
                </a>
              </li>
              <li th:each="page : ${#numbers.sequence(0, memberTimesPaging.totalPages - 1)}"
                  th:if="${page >= memberTimesPaging.totalPages - 5 and page <= memberTimesPaging.number+5}"
                  th:classappend="${page == memberTimesPaging.number} ? 'active'"
                  class="page-item">
                <a th:text="${page+1}" class="page-link" th:href="@{|?page=${page}&memberTag=${memberTag}|}"></a>
              </li>
              <li class="page-item" th:classappend="${!memberTimesPaging.hasNext()} ? 'disabled'">
                <a class="page-link" th:href="@{|?page=${memberTimesPaging.number + 1}&memberTag=${memberTag}|}">
                  <span>></span>
                </a>
              </li>
            </ul>
          </div>
        </th:block>
        </div>

      <div class="col-5 member-detail" id="member-detail" hidden="hidden">
        <!-- 선택한 주문의 상세 정보를 표시 -->
        <div class="col-12" id="memberDetailHeader" style="height: 25%; display: flex; flex-wrap: wrap; border-bottom: 2px solid dimgray; padding-bottom: 2px;">
          <div class="col-12 center" style="margin-bottom: 0">
            <h3><strong><주문 상세></strong></h3>
          </div>
          <div class="col-12">주문 번호 : <span id="orderId"></span></div>
          <div class="col-12">주문명 : <span id="orderName"></span></div>
          <div class="col-12">주문 날짜 : <span id="orderDate"></span></div>
          <div class="col-12">주문 상태 : <span id="orderStatus"></span></div>
        </div>
        <div class="col-12" id="memberDetailBody" style="height: 55%; border-bottom: 2px solid dimgray;">
          <table style="width: 100%; height: 100%; margin-top: 3px;">
            <thead style="width: 100%; border-top: 1px solid dimgray; border-bottom: 1px solid dimgray;">
            <tr style="display: table; width: 100% ">
              <td style="text-align: center; width: 24%">상품 이름</td>
              <td style="text-align: center; width: 20%">금액</td>
              <td style="text-align: center; width: 12%">수량</td>
              <td style="text-align: center; width: 24%">할인 금액</td>
              <td style="text-align: center; width: 20%">총 금액</td>
            </tr>
            </thead>
            <tbody id="membersList">
            <!-- 주문 선택 시 리스트가 생김-->
            </tbody>
            <tfoot style="width: 100%; height: 15%;">
            <tr style="display: table; width: 100%; height: 100%">
              <td colspan="4" style="width: 70%; text-align: center"><strong>총 주문 금액</strong></td>
              <td id="orderAmount" style="width: 30%; text-align: right; padding-right: 5px">0 원</td>
            </tr>
            </tfoot>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- 결제 취소 버튼을 누르면 생기는 모달 -->
<div class="modal">
  <div class="modal-body">
    <div style="display: flex">
      <h1 class="col-4" style="text-align: left" onclick="Back()";><strong>←</strong></h1>
      <h1 class="col-8" style="text-align: left"><strong>결제취소</strong></h1>
    </div>
    <div style="display:flex; justify-content: left; align-items: center; height: 60%;">
      <div>
        <h2>주문 명 : <strong id="cancelOrderName"></strong></h2>
        <h2> 에 대해 결제를 취소하시겠습니까?</h2></br>
        <h3>총 금액은 <input id="cancelOrderAmount" type="text" style="width:30%; text-align: right; background-color: transparent; border: none; color: red;">원입니다.</h3></br>
      </div>
    </div>
    <form action="cancel" method="post">
      <input type="hidden" name="cancelOrderId" id="cancelOrderId">

      <div class="center" style="display: flex">
        <input type="submit" class="button" style="height: 80px" value="네">
        <input type="button" class="button" onclick="Back()" style="height: 80px; background-color: gray;" value="아니요">
      </div>
    </form>
  </div>
</div>
<script th:inline="javascript">

  // 화면이 load될때 실행
  function memberTagSelect() {
    // memberTag를 받아온다
    var memberTag = /*[[${memberTag}]]*/ [];

    // members table을 검색
    var members = document.getElementsByClassName("members");

    if (memberTag === "admin") { // memberTag가 admin일 경운 admin tag에 selected 클래스를 추가한다.
      // id가 admin인 객체에 selected 클래스 부여
      document.getElementById("admin").classList.add("selected");

      // 회원정보 수정 & 월급 관리 table display를 none으로 한다.
      members[1].style.display = "none";
      members[2].style.display = "none";
    } else if (memberTag === "memberSet") {
      document.getElementById("memberSet").classList.add("selected");
      members[0].style.display = "none";
      members[2].style.display = "none";
      // pagination div class를 col-12로 변경
      document.getElementById("pagination").classList.remove("col-10");
      document.getElementById("pagination").classList.add("col-12");
      // saveButton hidden 설정
      document.getElementById("saveButton").hidden = "hidden";
    } else {
      // salary tag 선택
      document.getElementById("salary").classList.add("selected");
      // management div의 크기를 col-12에서 col-7로 변경한다.
      document.getElementById("management").classList.remove("col-12");
      document.getElementById("management").classList.add("col-7");
      document.getElementById("member-detail").hidden = undefined;

      // 회원정보 수정 & 월급 관리 tbody display를 none으로 한다.
      members[0].style.display = "none";
      members[1].style.display = "none";
    }
  }

  memberTagSelect();

  function selectOrder(event, order) {
    // 모든 tr 요소에서 selected 클래스 제거
    var cells = document.querySelectorAll(".orderList tr");
    cells.forEach(function(cell) {
      cell.classList.remove("selected");
    });

    if (event)
            // 클릭된 tr요소에 selected 클래스 추가
      event.currentTarget.classList.add("selected");
    else {
      // 클릭된 요소가 없는 경우 해당 order id를 찾아서 selected 클래스 부여
      document.getElementById(order['id']).classList.add("selected");
    }

    // order의 내용을 orderDetail에 삽입
    document.getElementById("orderId").innerText = order['id'];
    document.getElementById("orderName").innerText = order['orderName'];
    document.getElementById("orderDate").innerText = order['orderDate'];
    document.getElementById("orderStatus").innerText = order['status'];
    if (order['status'] === "CANCEL") {
      document.getElementById("orderStatus").style.color = "red";
      document.getElementById("orderDate").innerText += '(취소)';
    } else {
      // cancel이 아닌 경우 style다시 black으로 변경
      document.getElementById("orderStatus").style.color = "black";
    }

    // tbody 'orderItemLists' 에 상품 차례대로 삽입
    var itemList = order['orderItems'];
    var orderItemLists_html = '';
    for (const item in itemList) {
      orderItemLists_html += "<tr style='display: table; width: 100%'>"
      orderItemLists_html += "<td style='width: 24%'>" + itemList[item]['item']['name'] + "</td>"
      orderItemLists_html += "<td style='width: 20%'>" + itemList[item]['item']['price'] + "원" + "</td>"
      orderItemLists_html += "<td style='width: 12%'>" + itemList[item]['count'] + "개" + "</td>"
      orderItemLists_html += "<td style='width: 24%'>" + itemList[item]['discount'] + "원" + "</td>"
      orderItemLists_html += "<td style='width: 20%'>" + itemList[item]['orderPrice'] + "원" + "</td>"
      orderItemLists_html += "</tr>"
    }

    // 주문 상세 내역
    document.getElementById("orderItemLists").innerHTML = orderItemLists_html;
    document.getElementById("orderAmount").innerText = order['amount'] + " 원";
    document.getElementById("payMethod").innerText = order['approve'];

    // 주문 상태가 cancel인 경우 취소 완료 버튼을 보여주고 order인 경우 결제 취소 버튼을 출력한다.
    if (order['status'] == 'ORDER') {
      document.getElementById("cancelButton").innerHTML =
              "<button class='button' onClick='OpenCancelModal()'>결제 취소</button>";
    } else if (order['status'] == 'CANCEL') {
      document.getElementById("cancelButton").innerHTML =
              "<button class='button' style='background-color: #4caf50'>취소 완료</button>";
    }
    // modal에 필요한 정보 삽입
    document.getElementById("cancelOrderId").value = order['id'];
    document.getElementById("cancelOrderName").innerText = order['orderName'];
    document.getElementById("cancelOrderAmount").value = order['amount'];
  }


</script>
<script>

  // 결제 취소 modal 화면에 표시하기
  function OpenCancelModal() {
    var selected = document.querySelectorAll('.selected');

    // 상품이 선택 되었을 때만 화면에 표시
    if ( selected.length != 0 ) {
      const modal = document.querySelector('.modal')

      modal.style.display = "flex";
    }
  }

  // 결제 취소 modal 화면 감추기
  function Back() {
    const modal = document.querySelector('.modal')

    modal.style.display="none";
  }

  function searchResult() {
    var result = /*[[${searchResult}]]*/ [];

    if (!result) {
      alert("검색 실패!\n검색한 상품이 존재하지 않습니다.");
    }
  }

  searchResult();
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
